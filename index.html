<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üöÄ Automa Pro Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* your CSS as provided, omitted here for brevity - keep unchanged */
  </style>
</head>
<body>
  <div class="toast-container-custom" id="toastContainer"></div>

  <div class="container-custom">
    <div class="header-section">
      <div>
        <h1>üöÄ Automa Pro Dashboard</h1>
        <p style="color: rgba(255,255,255,0.8); margin-top: 5px;">Advanced Mobile-to-Desktop Automation</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="chip" onclick="toggleTheme()" title="Dark Mode">
          <i class="fas fa-moon"></i>
        </button>
        <button class="chip" onclick="showStats()" title="View Statistics">
          <i class="fas fa-chart-bar"></i>
        </button>
      </div>
    </div>

    <div id="statsSection" style="display:none;margin-bottom:30px;">
      <!-- stats cards here -->
    </div>

    <div class="info-box">
      <strong>üìä Real-time Google Sheets Integration</strong>
      <p style="margin: 10px 0 0 0; font-size: 14px;">
        ‡§Ø‡§π dashboard ‡§∏‡•Ä‡§ß‡•á Google Sheets ‡§ï‡•á ‡§∏‡§æ‡§• integrated ‡§π‡•à‡•§ Button click ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ sheet ‡§Æ‡•á‡§Ç ‡§§‡•Å‡§∞‡§Ç‡§§ value update ‡§π‡•ã‡§ó‡•Ä ‡§î‡§∞ Automa automatically trigger ‡§π‡•ã‡§ó‡§æ‡•§
      </p>
    </div>

    <div class="status-grid">
      <!-- status cards here -->
    </div>

    <div class="button-group">
      <button class="btn-custom btn-trigger" onclick="triggerWorkflow(event)">
        <i class="fas fa-play"></i> üöÄ Trigger Workflow
      </button>
      <button class="btn-custom btn-reset" onclick="resetWorkflow(event)">
        <i class="fas fa-redo"></i> üîÑ Reset to NO
      </button>
      <button class="btn-custom btn-pause" onclick="pauseWorkflow(event)">
        <i class="fas fa-pause"></i> ‚è∏Ô∏è Pause
      </button>
      <button class="btn-custom" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="viewFullHistory()">
        <i class="fas fa-history"></i> üìú History
      </button>
    </div>

    <div class="history-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h4>üìù Execution History</h4>
        <button class="refresh-btn" onclick="refreshData(event)">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div id="historyContainer" style="max-height:400px;overflow-y:auto;">
        <div style="text-align:center;color:#999;">
          <i class="fas fa-inbox" style="font-size:24px;margin-bottom:10px;"></i>
          <p>No execution history yet</p>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:40px;color:rgba(255,255,255,0.8);font-size:12px;">
      <p>
        üîó <a href="https://docs.google.com/spreadsheets/d/179nsb7VcX86_gJqz10p6ZUz_qU23ROEfJyGNuJokHuw/" target="_blank" style="color:white;text-decoration:none;">View Google Sheet</a> | 
        <a href="https://automa-docs-old.vercel.app/" target="_blank" style="color:white;text-decoration:none;">Automa Docs</a>
      </p>
      <p style="margin-top:10px;">Production Ready ‚Ä¢ Mobile Optimized ‚Ä¢ Real-time Sync</p>
    </div>
  </div>

<script>
  const CONFIG = {
    SHEET_ID: "179nsb7VcX86_gJqz10p6ZUz_qU23ROEfJyGNuJokHuw",
    APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbzoe9pO6im_Wn3-Nq4VgbjkkGzixY4_V0cgVtX3FGwN-mNE4rsR3fkAc1y657DAyGpQ/exec",
    POLL_INTERVAL: 30000,
    LOCAL_STORAGE_KEY: "automaDashboardState"
  };

  let appState = {
    triggerStatus: "NO",
    workflowStatus: "Waiting",
    executionCount: 0,
    successCount: 0,
    history: [],
    isPaused: false,
    lastSync: null,
    theme: localStorage.getItem("automaTheme") || "light"
  };

  const el = id => document.getElementById(id);
  const nowStr = () => new Date().toLocaleString("hi-IN");

  function showToast(message, type = "success", duration = 3000) {
    const container = el("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast-custom ${type}`;

    const icons = {
      success: '<i class="fas fa-check-circle" style="color:#27ae60;"></i>',
      error: '<i class="fas fa-exclamation-circle" style="color:#e74c3c;"></i>',
      warning: '<i class="fas fa-exclamation-triangle" style="color:#f39c12;"></i>',
      info: '<i class="fas fa-info-circle" style="color:#3498db;"></i>'
    };

    toast.innerHTML = `<div>${icons[type] || icons.info}</div><div>${message}</div>`;
    container.appendChild(toast);

    if(duration > 0){
      setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
  }

  function saveState() {
    localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(appState));
  }

  function loadState() {
    const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
    if (saved) {
      try {
        appState = {...appState, ...JSON.parse(saved)};
      } catch(e) {
        console.error("Error loading state:", e);
      }
    }
  }

  async function safeFetch(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const text = await response.text();
      if(/^\s*<!DOCTYPE|^\s*<html/i.test(text)) throw new Error("Invalid HTML response");
      return text.trim();
    } catch (err) {
      console.error(err);
      throw err;
    }
  }

  async function updateGoogleSheet(value) {
    try {
      const res = await safeFetch(`${CONFIG.APPS_SCRIPT_URL}?action=setCell&value=${value}`);
      return res === "OK";
    } catch {
      showToast("‚ùå Google Sheet update failed", "error");
      return false;
    }
  }

  async function getGoogleSheetValue() {
    try {
      return await safeFetch(`${CONFIG.APPS_SCRIPT_URL}?action=getCell`);
    } catch {
      return appState.triggerStatus;
    }
  }

  function updateUI() {
    el("triggerValue").textContent = appState.triggerStatus;
    const on = appState.triggerStatus === "YES";
    const badge = el("triggerBadge");
    badge.textContent = on ? "ON" : "OFF";
    badge.className = on ? "badge-custom badge-success" : "badge-custom badge-error";

    el("workflowValue").textContent = appState.workflowStatus;
    el("executionCount").textContent = appState.executionCount;

    const percent = appState.executionCount > 0 ? Math.round((appState.successCount / appState.executionCount)*100) : 0;
    el("successPercentage").textContent = percent + "%";
    el("progressBar").style.width = percent + "%";

    el("lastUpdatedTime").textContent = nowStr();
    saveState();
  }

  function addHistory(text, success=true) {
    appState.history.unshift({ text, success, timestamp: nowStr() });
    if (appState.history.length > 50) appState.history.length = 50;
    updateHistoryUI();
    saveState();
  }

  function updateHistoryUI() {
    const container = el("historyContainer");
    if (!appState.history.length) {
      container.innerHTML = `<div style="text-align:center;color:#999"><i class="fas fa-inbox" style="font-size:24px;margin-bottom:10px"></i><p>No execution history yet</p></div>`;
      return;
    }
    container.innerHTML = appState.history.map(h => `
      <div class="history-item ${h.success ? "success" : "error"}">
        <div><strong>${h.text}</strong><div style="font-size:12px;opacity:0.7;margin-top:3px">${h.timestamp}</div></div>
        <span class="badge-custom ${h.success ? "badge-success" : "badge-error"}">${h.success ? "‚úÖ Success" : "‚ùå Error"}</span>
      </div>
    `).join("");
  }

  async function triggerWorkflow(event) {
    if(appState.isPaused){
      showToast("‚è∏Ô∏è Workflow is paused", "warning");
      return;
    }
    const btn = event.currentTarget;
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div> Updating...';

    if(await updateGoogleSheet("YES")){
      appState.triggerStatus = "YES";
      appState.workflowStatus = "Triggered";
      appState.executionCount++;
      addHistory("üöÄ Triggered (A2=YES)");
      showToast("‚úÖ Triggered successfully!", "success");
    } else {
      addHistory("‚ùå Trigger failed", false);
      showToast("‚ùå Trigger failed", "error");
    }
    updateUI();
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play"></i> üöÄ Trigger Workflow';
  }

  async function resetWorkflow(event) {
    const btn = event.currentTarget;
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div> Resetting...';

    if(await updateGoogleSheet("NO")){
      appState.triggerStatus = "NO";
      appState.workflowStatus = "Waiting";
      appState.successCount++;
      addHistory("üîÑ Reset (A2=NO)");
      showToast("‚úÖ Reset successful!", "success");
    } else {
      addHistory("‚ùå Reset failed", false);
      showToast("‚ùå Reset failed", "error");
    }
    updateUI();
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-redo"></i> üîÑ Reset to NO';
  }

  function pauseWorkflow(event) {
    appState.isPaused = !appState.isPaused;
    const btn = event.currentTarget;
    if(appState.isPaused){
      btn.innerHTML = '<i class="fas fa-play"></i> ‚ñ∂Ô∏è Resume';
      showToast("‚è∏Ô∏è Workflow paused", "info");
      addHistory("‚è∏Ô∏è Workflow paused");
    } else {
      btn.innerHTML = '<i class="fas fa-pause"></i> ‚è∏Ô∏è Pause';
      showToast("‚ñ∂Ô∏è Workflow resumed", "info");
      addHistory("‚ñ∂Ô∏è Workflow resumed");
    }
    saveState();
  }

  function viewFullHistory() {
    console.table(appState.history);
    showToast("üìú Execution history copied to console.", "info", 5000);
  }

  function showStats() {
    const statsSection = el("statsSection");
    statsSection.style.display = (statsSection.style.display === "none") ? "block" : "none";
  }

  function toggleTheme() {
    if(document.body.classList.contains("dark-mode")){
      document.body.classList.remove("dark-mode");
      appState.theme = "light";
    } else {
      document.body.classList.add("dark-mode");
      appState.theme = "dark";
    }
    localStorage.setItem("automaTheme", appState.theme);
  }

  async function refreshData(event) {
    const btn = event.currentTarget;
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-sync-alt" style="animation: spin 0.8s linear infinite;"></i> Syncing...';

    try {
      const val = await getGoogleSheetValue();
      appState.triggerStatus = (val === "YES" || val === "NO") ? val : appState.triggerStatus;
      if(val === "NO") appState.workflowStatus = "Waiting";
      addHistory("üîÑ Manual Refresh");
      showToast("‚úÖ Data synchronized!", "success");
      updateUI();
    } catch (e) {
      showToast("‚ùå Sync failed", "error");
    }

    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }

  // Auto polling of Google Sheets value (every 30 seconds)
  window.addEventListener("DOMContentLoaded", () => {
    loadState();
    if(appState.theme === "dark") document.body.classList.add("dark-mode");
    updateUI();
    updateHistoryUI();
    showToast("‚úÖ Dashboard loaded", "success", 3000);

    setInterval(async () => {
      if (!appState.isPaused) {
        try {
          const val = await getGoogleSheetValue();
          if(val !== appState.triggerStatus){
            appState.triggerStatus = val;
            if(val === "NO"){
              appState.workflowStatus = "COMPLETED";
              appState.successCount++;
              addHistory("‚úÖ Workflow Completed");
              showToast("‚úÖ Workflow Completed", "success");
            }
            updateUI();
          }
        } catch (e) {
          console.error("Polling error:", e);
        }
      }
    }, CONFIG.POLL_INTERVAL);
  });

  window.addEventListener("beforeunload", saveState);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
