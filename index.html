<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöÄ Automa Pro Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* keep your styles exactly as in your last version */
    /* ‚Ä¶ your CSS from the question ‚Ä¶ */
  </style>
</head>
<body>
  <div class="toast-container-custom" id="toastContainer"></div>

  <div class="container-custom">
    <!-- header, info, KPIs, buttons, history exactly as in your file -->
    <!-- ‚Ä¶ your HTML from the question ‚Ä¶ -->
  </div>

<script>
  // ==================== CONFIG ====================
  const CONFIG = {
    SHEET_ID: "179nsb7VcX86_gJqz10p6ZUz_qU23ROEfJyGNuJokHuw",
    APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbzoe9pO6im_Wn3-Nq4VgbjkkGzixY4_V0cgVtX3FGwN-mNE4rsR3fkAc1y657DAyGpQ/exec",
    POLL_INTERVAL: 30000,
    LOCAL_STORAGE_KEY: "automaDashboardState"
  };

  // ==================== STATE ====================
  let appState = {
    triggerStatus: "NO",
    workflowStatus: "Waiting",
    executionCount: 0,
    successCount: 0,
    history: [],
    isPaused: false,
    lastSync: null,
    theme: localStorage.getItem("automaTheme") || "light"
  };

  // ==================== UTIL ====================
  const el = id => document.getElementById(id);
  const nowStr = () => new Date().toLocaleString("hi-IN");

  function showToast(message, type="success", duration=3000){
    const container = el("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast-custom ${type}`;
    const icons = {
      success:'<i class="fas fa-check-circle" style="color:#27ae60;"></i>',
      error:'<i class="fas fa-exclamation-circle" style="color:#e74c3c;"></i>',
      warning:'<i class="fas fa-exclamation-triangle" style="color:#f39c12;"></i>',
      info:'<i class="fas fa-info-circle" style="color:#3498db;"></i>'
    };
    toast.innerHTML = `<div>${icons[type]||icons.info}</div><div>${message}</div>`;
    container.appendChild(toast);
    if(duration>0){
      setTimeout(()=>{ toast.style.animation="slideIn .3s ease reverse"; setTimeout(()=>toast.remove(),300); }, duration);
    }
  }

  function saveState(){ localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(appState)); }
  function loadState(){
    const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
    if(saved){ try{ appState = {...appState, ...JSON.parse(saved)}; } catch(e){ console.error(e); } }
  }

  // Hardened fetch: timeout, status, HTML guard
  async function safeFetch(url, timeoutMs=10000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, { signal: ctrl.signal, credentials: "omit", cache: "no-cache" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = (await res.text()).trim();
      if(/^<!DOCTYPE|^<html/i.test(text)) throw new Error("HTML response");
      return text;
    } finally {
      clearTimeout(t);
    }
  }

  // ==================== API ====================
  async function updateGoogleSheet(value){
    const qs = new URLSearchParams({ action: "setCell", value: String(value) });
    try{
      const text = await safeFetch(`${CONFIG.APPS_SCRIPT_URL}?${qs.toString()}`);
      return text === "OK";
    }catch(err){
      console.error("setCell error:", err);
      showToast("‚ùå Error updating Google Sheet", "error");
      return false;
    }
  }

  async function getGoogleSheetValue(){
    const qs = new URLSearchParams({ action: "getCell" });
    try{
      const text = await safeFetch(`${CONFIG.APPS_SCRIPT_URL}?${qs.toString()}`);
      return text;
    }catch(err){
      console.error("getCell error:", err);
      return appState.triggerStatus; // fallback to last known
    }
  }

  // ==================== UI ====================
  function updateUI(){
    el("triggerValue").textContent = appState.triggerStatus;
    const badge = el("triggerBadge");
    const on = appState.triggerStatus === "YES";
    badge.textContent = on ? "ON" : "OFF";
    badge.className = on ? "badge-custom badge-success" : "badge-custom badge-error";

    el("workflowValue").textContent = appState.workflowStatus;
    el("executionCount").textContent = appState.executionCount;

    const pct = appState.executionCount ? Math.round((appState.successCount/appState.executionCount)*100) : 0;
    el("successPercentage").textContent = pct+"%";
    el("progressBar").style.width = pct+"%";

    el("lastUpdatedTime").textContent = nowStr();
    saveState();
  }

  function addHistory(text, ok=true){
    appState.history.unshift({ text, ok, ts: nowStr() });
    if(appState.history.length>50) appState.history.length=50;
    renderHistory(); saveState();
  }

  function renderHistory(){
    const box = el("historyContainer");
    if(!appState.history.length){
      box.innerHTML = `<div style="text-align:center;color:#999"><i class="fas fa-inbox" style="font-size:24px;margin-bottom:10px"></i><p>No execution history yet</p></div>`;
      return;
    }
    box.innerHTML = appState.history.map(h => `
      <div class="history-item ${h.ok ? "success":"error"}">
        <div><strong>${h.text}</strong><div style="font-size:12px;opacity:.7;margin-top:4px">${h.ts}</div></div>
        <span class="badge-custom ${h.ok ? "badge-success":"badge-error"}">${h.ok ? "‚úÖ Success":"‚ùå Error"}</span>
      </div>
    `).join("");
  }

  // ==================== Actions (pass event) ====================
  async function triggerWorkflow(ev){
    if(appState.isPaused){ showToast("‚è∏Ô∏è Workflow is paused","warning"); return; }
    const btn = ev.currentTarget; const old = btn.innerHTML; btn.disabled=true; btn.innerHTML = '<div class="loading-spinner"></div> Updating...';
    const ok = await updateGoogleSheet("YES");
    if(ok){
      appState.triggerStatus="YES"; appState.workflowStatus="Triggered"; appState.executionCount++;
      addHistory("üöÄ Triggered (A2=YES)", true); showToast("‚úÖ Triggered", "success");
    }else{
      addHistory("‚ùå Trigger failed", false);
    }
    updateUI(); btn.disabled=false; btn.innerHTML = old;
  }

  async function resetWorkflow(ev){
    const btn = ev.currentTarget; const old = btn.innerHTML; btn.disabled=true; btn.innerHTML = '<div class="loading-spinner"></div> Resetting...';
    const ok = await updateGoogleSheet("NO");
    if(ok){
      appState.triggerStatus="NO"; appState.workflowStatus="Waiting"; appState.successCount++;
      addHistory("üîÑ Reset (A2=NO)", true); showToast("‚úÖ Reset", "success");
    }else{
      addHistory("‚ùå Reset failed", false);
    }
    updateUI(); btn.disabled=false; btn.innerHTML = old;
  }

  function pauseWorkflow(ev){
    const btn = ev.currentTarget;
    appState.isPaused = !appState.isPaused;
    if(appState.isPaused){
      btn.innerHTML = '<i class="fas fa-play"></i> ‚ñ∂Ô∏è Resume';
      addHistory("‚è∏Ô∏è Paused", true); showToast("‚è∏Ô∏è Paused","info");
    }else{
      btn.innerHTML = '<i class="fas fa-pause"></i> ‚è∏Ô∏è Pause';
      addHistory("‚ñ∂Ô∏è Resumed", true); showToast("‚ñ∂Ô∏è Resumed","info");
    }
    saveState();
  }

  async function refreshData(ev){
    const btn = ev.currentTarget; const old = btn.innerHTML; btn.disabled=true; btn.innerHTML = '<i class="fas fa-sync-alt" style="animation: spin .8s linear infinite;"></i> Syncing...';
    const v = await getGoogleSheetValue();
    if(v==="YES"||v==="NO"){ appState.triggerStatus=v; if(v==="NO") appState.workflowStatus="Waiting"; addHistory("üîÑ Manual Refresh", true); showToast("‚úÖ Synced","success"); }
    updateUI(); btn.disabled=false; btn.innerHTML = old;
  }

  function showStats(){ const s = document.getElementById("statsSection"); s.style.display = (s.style.display==="none"?"block":"none"); }
  function toggleTheme(){ document.body.classList.toggle("dark-mode"); appState.theme = document.body.classList.contains("dark-mode")?"dark":"light"; localStorage.setItem("automaTheme", appState.theme); }

  // ==================== Init & Poll ====================
  window.addEventListener("DOMContentLoaded", ()=>{
    loadState();
    if(appState.theme==="dark") document.body.classList.add("dark-mode");
    updateUI(); renderHistory();
    showToast("‚úÖ Dashboard loaded","success",2500);

    setInterval(async ()=>{
      if(appState.isPaused) return;
      try{
        const v = await getGoogleSheetValue();
        if(v!==appState.triggerStatus){
          const wasYES = appState.triggerStatus==="YES";
          appState.triggerStatus = v;
          if(wasYES && v==="NO"){ appState.workflowStatus="COMPLETED"; appState.successCount++; addHistory("‚úÖ Workflow Completed", true); showToast("‚úÖ Completed","success"); }
          updateUI();
        }
      }catch(e){ console.error("poll error", e); }
    }, CONFIG.POLL_INTERVAL);
  });

  window.addEventListener("beforeunload", saveState);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
